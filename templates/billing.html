{% extends "layout_app.html" %}
{% set page_title = "Billing" %}
{% set active = "billing" %}

{% block app_content %}
  <div class="card">
    <div class="card__title">Subscription</div>
    <div class="muted" style="margin-bottom:12px">Manage your plan, sync status from Stripe, or open the customer portal.</div>

    {% if not stripe_enabled %}
      <div class="toast toast--error">Stripe is not configured on this deployment.</div>
    {% endif %}

    <div class="grid3" style="margin-top:10px">
      <div class="card card--inset">
        <div class="muted">Current plan</div>
        <div class="big">{{ user_plan_label }}</div>
        <div class="muted small" style="margin-top:6px">Status: <span class="mono">{{ user_stripe_status or 'â€”' }}</span></div>
        {% if period_end %}
          <div class="muted small" style="margin-top:6px">Next renewal: <span class="mono">{{ period_end }}</span></div>
        {% endif %}
        {% if cancel_at_period_end %}
          <div class="toast toast--warn" style="margin-top:10px">Canceling at period end.</div>
        {% endif %}
      </div>

      <div class="card card--inset">
        <div class="muted">Upgrade</div>
        <div class="muted small" style="margin-top:6px">Unlimited analyses, journal, performance stats, lessons.</div>
        <form action="{{ url_for('billing_checkout') }}" method="post" style="margin-top:10px">
          <button class="btn btn--primary w100" type="submit" name="plan" value="pro_monthly" {% if not stripe_enabled %}disabled{% endif %}>Go Pro (Monthly)</button>
          <button class="btn btn--ghost w100" type="submit" name="plan" value="pro_yearly" style="margin-top:8px" {% if not stripe_enabled %}disabled{% endif %}>Go Pro (Yearly)</button>
        </form>
      </div>

      <div class="card card--inset">
        <div class="muted">Actions</div>
        <div class="stack" style="margin-top:10px">
          <form action="{{ url_for('billing_sync') }}" method="post">
            <button class="btn btn--ghost w100" type="submit" {% if not stripe_enabled %}disabled{% endif %}>Sync status</button>
          </form>

          <form action="{{ url_for('billing_portal') }}" method="get">
            <button class="btn btn--ghost w100" type="submit" {% if not stripe_enabled or not user['stripe_customer_id'] %}disabled{% endif %}>Open Stripe portal</button>
          </form>

          <div class="grid2" style="gap:10px">
            <form action="{{ url_for('billing_cancel') }}" method="post">
              <button class="btn btn--ghost w100" type="submit" {% if not stripe_enabled or not user['stripe_subscription_id'] %}disabled{% endif %}>Cancel</button>
            </form>
            <form action="{{ url_for('billing_resume') }}" method="post">
              <button class="btn btn--ghost w100" type="submit" {% if not stripe_enabled or not user['stripe_subscription_id'] %}disabled{% endif %}>Resume</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <div class="muted" style="margin-top:12px">This tool is educational and does not constitute financial advice.</div>
  </div>
{% endblock %}
