{% extends "base.html" %}
{% block title %}TraderAI — Dashboard{% endblock %}
{% block content %}
<section class="dash">
  <aside class="sidebar card">
    <div class="sidebar__top">
      <div class="sidebar__title">Dashboard</div>
      <div class="muted">{{ user['email'] }}</div>
    </div>

    <div class="kpi">
      <div class="kpi__row">
        <span class="muted">Plan</span>
        <span class="mono">{{ user['plan'] }}</span>
      </div>

      {% if user['plan'] != 'free' %}
      <div class="kpi__row">
        <span class="muted">Status</span>
        <span class="mono">{{ user['stripe_status'] or '—' }}</span>
      </div>
      {% endif %}

      <div class="kpi__row">
        <span class="muted">Analyses (this month)</span>
        <span class="mono">{{ user['analyses_used'] }}</span>
      </div>

      {% if remaining is not none %}
      <div class="kpi__row">
        <span class="muted">Remaining</span>
        <span class="mono">{{ remaining }}</span>
      </div>
      {% endif %}

      <div class="kpi__hint muted">
        Free: {{ FREE_MONTHLY_LIMIT }}/mo • Pro: unlimited
      </div>
    </div>

    <div class="sidebar__actions">
      <a class="btn btn--ghost" href="{{ url_for('pricing') }}">Pricing / Upgrade</a>
      {% if user['stripe_customer_id'] %}
        <a class="btn btn--ghost" href="{{ url_for('billing_portal') }}">Manage subscription</a>
      {% endif %}
      <a class="btn btn--ghost" href="{{ url_for('logout') }}">Log out</a>
    </div>

    <div class="card card--inset" style="margin-top:14px">
      <div class="muted" style="margin-bottom:8px">Recent analyses</div>
      {% if recent and recent|length %}
        <div class="list">
          {% for r in recent %}
            <a class="list__row" href="{{ url_for('analysis_view', analysis_id=r['id']) }}">
              <span class="mono">{{ r['pair'] }} • {{ r['timeframe'] }}</span>
              <span class="muted">{{ r['created_at'][:10] }}</span>
            </a>
          {% endfor %}
        </div>
      {% else %}
        <div class="muted">No history yet.</div>
      {% endif %}
    </div>
  </aside>

  <div class="dash__main">
    <div class="card">
      <div class="card__title">Chart analysis</div>
      <div class="muted" style="margin-bottom:12px">
        Upload a chart screenshot. You will get: direction (long/short) + entry + take profit + stop loss.
      </div>

      {% if not openai_enabled %}
        <div class="toast toast--error">
          OpenAI is not configured (OPENAI_API_KEY). Analyses are temporarily unavailable.
        </div>
      {% endif %}

      <form class="form" action="{{ url_for('analyze') }}" method="post" enctype="multipart/form-data">
        <div class="grid3">
          <label class="field">
            <span class="field__label">Symbol</span>
            <input name="pair" value="{{ user['default_pair'] or 'BTCUSDT' }}" placeholder="e.g. BTCUSDT" required />
          </label>

          <label class="field">
            <span class="field__label">Timeframe</span>
            <input name="timeframe" value="{{ user['default_timeframe'] or '1H' }}" placeholder="e.g. 15M / 1H / 4H" required />
          </label>

          <label class="field">
            <span class="field__label">Capital</span>
            <input name="capital" value="{{ user['default_capital'] or 1000 }}" inputmode="decimal" placeholder="e.g. 10000" required />
          </label>
        </div>

        <div class="grid3" style="margin-top:10px">
          <label class="field">
            <span class="field__label">Risk per trade</span>
            <input name="risk_fraction" value="{{ user['default_risk_fraction'] or 0.02 }}" inputmode="decimal" placeholder="e.g. 0.02 = 2%" required />
            <span class="field__hint muted">Enter as a fraction of capital (0.02 = 2%).</span>
          </label>

          <label class="field">
            <span class="field__label">Screenshot (PNG/JPG/WEBP)</span>
            <input name="chart" type="file" accept=".png,.jpg,.jpeg,.webp" required />
          </label>

          <div class="field">
            <span class="field__label">Action</span>
            <button class="btn btn--primary" type="submit" {% if not openai_enabled %}disabled{% endif %}>Analyze</button>
            <span class="field__hint muted">Free limit: {{ FREE_MONTHLY_LIMIT }}/mo • News is fetched automatically.</span>
          </div>
        </div>
      </form>
    </div>

    {% if last %}
      {% set result = last['result_json'] | loads %}
      <div class="card" style="margin-top:16px">
        <div class="card__title">Last analysis</div>

        <div class="grid2">
          <div class="card card--inset">
            <div class="trade-head">
              <div class="muted">{{ result.pair }} • {{ result.timeframe }}</div>
              {% if result.signal == "LONG" %}
                <div class="signal-banner signal-banner--long">long</div>
              {% elif result.signal == "SHORT" %}
                <div class="signal-banner signal-banner--short">short</div>
              {% else %}
                <div class="signal-banner signal-banner--no">no trade</div>
              {% endif %}
            </div>

            {% if result.signal != "NO_TRADE" %}
              <div class="trade-grid">
                <div class="trade-box trade-box--entry">
                  <div class="trade-box__label">Entry</div>
                  <div class="trade-box__value">{{ result.entry }}</div>
                </div>
                <div class="trade-box trade-box--tp">
                  <div class="trade-box__label">Take profit</div>
                  <div class="trade-box__value">
                    {% if result.take_profit and result.take_profit|length %}
                      <div class="chips">
                        {% for tp in result.take_profit %}
                          <span class="chip">{{ tp }}</span>
                        {% endfor %}
                      </div>
                    {% else %}
                      —
                    {% endif %}
                  </div>
                </div>
                <div class="trade-box trade-box--sl">
                  <div class="trade-box__label">Stop loss</div>
                  <div class="trade-box__value">{{ result.stop_loss }}</div>
                </div>
              </div>

              {% if result.rationale is defined and result.rationale and result.rationale|length %}
                <details class="trade-why">
                  <summary>Rationale</summary>
                  <ul>
                    {% for line in result.rationale %}
                      <li>{{ line }}</li>
                    {% endfor %}
                  </ul>
                </details>
              {% endif %}
            {% else %}
              <div class="muted" style="margin-top:10px">
                {{ result.setup }}
                {% if not result.is_chart %}
                  <div class="muted" style="margin-top:6px">
                    I can't see a readable price chart in this screenshot. If you're uploading a full desktop view, zoom in or crop to the chart area (candles + price axis + time axis).
                  </div>
                {% endif %}
              </div>
            {% endif %}
          </div>

          <div class="card card--inset">
            <div class="muted" style="margin-top:14px">Screenshot preview</div>
            <img class="img-preview" src="data:{{ last['image_mime'] }};base64,{{ last['image_b64'] }}" alt="Uploaded screenshot" />
          </div>
        </div>

        <div class="muted" style="margin-top:10px">
          Disclaimer: This tool is for educational purposes only and is not investment advice.
        </div>
      </div>
    {% endif %}
  </div>
</section>
{% endblock %}
