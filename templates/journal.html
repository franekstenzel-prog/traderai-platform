{% extends "layout_app.html" %}
{% set page_title = "Journal" %}
{% set active = "journal" %}

{% block app_content %}
  <div class="grid2">
    <div class="card">
      <div class="card__title">Log a trade</div>
      <form class="form" action="{{ url_for('journal') }}" method="post">
        <div class="grid2">
          <label class="field">
            <span class="field__label">Symbol</span>
            <input name="symbol" value="{{ defaults.symbol }}" placeholder="BTCUSDT" required />
          </label>
          <label class="field">
            <span class="field__label">Mode</span>
            <select name="mode">
              <option value="scalp" {% if defaults.mode=='scalp' %}selected{% endif %}>Scalp</option>
              <option value="swing" {% if defaults.mode=='swing' %}selected{% endif %}>Swing</option>
            </select>
          </label>
        </div>

        <div class="grid3" style="margin-top:10px">
          <label class="field">
            <span class="field__label">Side</span>
            <select name="side">
              <option value="LONG">LONG</option>
              <option value="SHORT">SHORT</option>
            </select>
          </label>
          <label class="field">
            <span class="field__label">Entry</span>
            <input name="entry" inputmode="decimal" placeholder="e.g. 102.5" />
          </label>
          <label class="field">
            <span class="field__label">Stop loss</span>
            <input name="stop" inputmode="decimal" placeholder="e.g. 99.8" />
          </label>
        </div>

        <div class="grid3" style="margin-top:10px">
          <label class="field">
            <span class="field__label">Exit</span>
            <input name="exit" inputmode="decimal" placeholder="e.g. 110.0" />
            <span class="field__hint muted">Optional — add later if you want.</span>
          </label>
          <label class="field">
            <span class="field__label">Capital</span>
            <input name="capital" inputmode="decimal" value="{{ defaults.capital }}" />
          </label>
          <label class="field">
            <span class="field__label">Risk %</span>
            <input name="risk_fraction" inputmode="decimal" value="{{ defaults.risk_fraction }}" />
            <span class="field__hint muted">Use fraction (0.01 = 1%).</span>
          </label>
        </div>

        <label class="field" style="margin-top:10px">
          <span class="field__label">Notes</span>
          <textarea name="notes" rows="3" placeholder="Setup, mistake, context... (optional)"></textarea>
        </label>

        <button class="btn btn--primary" type="submit">Save trade</button>
      </form>
    </div>

    <div class="card">
      <div class="card__title">Quick stats</div>
      <div class="kpi">
        <div class="kpi__row"><span class="muted">Trades</span><span class="mono">{{ perf.count }}</span></div>
        <div class="kpi__row"><span class="muted">Win rate</span><span class="mono">{{ perf.win_rate }}%</span></div>
        <div class="kpi__row"><span class="muted">Net PnL (risk-based)</span><span class="mono">{{ perf.net_pnl }}</span></div>
        <div class="kpi__row"><span class="muted">Expectancy (R)</span><span class="mono">{{ perf.expectancy }}</span></div>
        <div class="kpi__row"><span class="muted">Profit factor</span><span class="mono">{{ perf.profit_factor }}</span></div>
      </div>
      <div class="muted small" style="margin-top:10px">
        PnL is computed from R-multiple × (capital × risk%). This is consistent across instruments.
      </div>
    </div>
  </div>

  <div class="card" style="margin-top:16px">
    <div class="card__title">Recent trades</div>
    {% if trades and trades|length %}
      <div class="table">
        <div class="table__row table__head">
          <div>Date</div><div>Symbol</div><div>Side</div><div>Mode</div><div>R</div><div>PnL</div><div></div>
        </div>
        {% for t in trades %}
          <div class="table__row">
            <div class="muted">{{ t.created_at[:10] }}</div>
            <div class="mono">{{ t.symbol }}</div>
            <div>{{ t.side }}</div>
            <div class="muted">{{ t.mode }}</div>
            <div class="mono">{{ '%.2f'|format(t.r_multiple or 0) if t.r_multiple is not none else '—' }}</div>
            <div class="mono">{{ '%.2f'|format(t.pnl or 0) if t.pnl is not none else '—' }}</div>
            <div>
              <form action="{{ url_for('journal_delete', trade_id=t.id) }}" method="post" onsubmit="return confirm('Delete this trade?')">
                <button class="btn btn--ghost" type="submit">Delete</button>
              </form>
            </div>
          </div>
          {% if t.notes %}
            <div class="table__row" style="border-top:none; opacity:.95">
              <div></div>
              <div class="muted" style="grid-column: span 6">{{ t.notes }}</div>
            </div>
          {% endif %}
        {% endfor %}
      </div>
    {% else %}
      <div class="muted">No trades yet.</div>
    {% endif %}
  </div>
{% endblock %}
